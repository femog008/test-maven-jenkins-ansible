---
# - hosts: localhost
  # connection: local 
  # become: true
  # become_user: vagrant
  # tasks:
    # - name: Package war file
      # command: 'mvn clean package'
    
- hosts: web
  become: true
  vars:
  - warName: DemoApp.war
  - warRemotePath: /usr/share/tomcat
  tasks:
    - name: include java
      include_role:
        name: geerlingguy.java
    - name: include tomcat
      include_role:
        name: tomcat
    - name: Creates directory
      file:
        path: '{{ warRemotePath }}/DemoApp'
        state: directory
    - name: Copy WAR to server
      copy:
        src: './target/demo-0.0.1-SNAPSHOT.war'
        dest: '{{ warRemotePath }}/{{ warName }}'
      # when:
        # - ansible_facts['distribution'] == 'RedHat'
    - name: Unzip WAR file
      unarchive: src='{{ warRemotePath }}/{{ warName }}' dest='{{ warRemotePath }}/DemoApp' copy=no mode=0755 owner=tomcat group=tomcat
      notify:
        - restart tomcat
    - name: Delete remote war file
      file: path={{ warRemotePath }}/{{ warName }} state=absent

  handlers:
  - name: restart tomcat8
    service: name=tomcat8 state=restarted